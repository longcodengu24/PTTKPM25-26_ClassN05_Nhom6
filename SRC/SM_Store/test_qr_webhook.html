<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test QR Code & Webhook - SePay</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .section {
                background: #f5f5f5;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
            }
            .qr-image {
                max-width: 300px;
                border: 1px solid #ddd;
                margin: 10px;
            }
            .status {
                padding: 10px;
                border-radius: 4px;
                margin: 10px 0;
            }
            .success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                margin: 5px;
                border-radius: 4px;
                cursor: pointer;
            }
            button:hover {
                background: #0056b3;
            }
            .result {
                background: white;
                padding: 15px;
                margin: 10px 0;
                border-radius: 4px;
                border: 1px solid #ddd;
            }
            pre {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
                overflow-x: auto;
            }
        </style>
    </head>
    <body>
        <h1>üß™ Test QR Code & Webhook Workflow</h1>

        <div class="section">
            <h2>üìù B∆∞·ªõc 1: T·∫°o giao d·ªãch test</h2>
            <button onclick="createTestTransaction()">
                T·∫°o giao d·ªãch test 50,000 VNƒê
            </button>
            <div
                id="transactionResult"
                class="result"
                style="display: none"
            ></div>
        </div>

        <div class="section">
            <h2>üîç B∆∞·ªõc 2: Ki·ªÉm tra n·ªôi dung QR</h2>
            <div id="qrSection" style="display: none">
                <p>
                    <strong>N·ªôi dung mong ƒë·ª£i khi qu√©t:</strong>
                    <span id="expectedContent"></span>
                </p>
                <div id="qrCodes"></div>
                <button onclick="checkQRContent()">Ki·ªÉm tra chi ti·∫øt QR</button>
            </div>
            <div id="qrResult" class="result" style="display: none"></div>
        </div>

        <div class="section">
            <h2>üè¶ B∆∞·ªõc 3: Gi·∫£ l·∫≠p webhook t·ª´ ng√¢n h√†ng</h2>
            <div id="webhookSection" style="display: none">
                <p class="info">
                    Sau khi chuy·ªÉn kho·∫£n v·ªõi ƒë√∫ng n·ªôi dung, ng√¢n h√†ng s·∫Ω g·ª≠i
                    webhook x√°c nh·∫≠n.
                </p>
                <button onclick="simulateWebhook()">
                    Gi·∫£ l·∫≠p webhook ng√¢n h√†ng
                </button>
            </div>
            <div id="webhookResult" class="result" style="display: none"></div>
        </div>

        <div class="section">
            <h2>üí∞ B∆∞·ªõc 4: Ki·ªÉm tra Firebase</h2>
            <button onclick="checkFirebase()">
                Ki·ªÉm tra balance tr√™n Firebase
            </button>
            <div id="firebaseResult" class="result" style="display: none"></div>
        </div>

        <script>
            let currentTransaction = null;

            async function createTestTransaction() {
                try {
                    const response = await fetch(
                        "/PTTKPM25-26_ClassN05_Nhom6/SRC/SM_Store/public/debug/create-test-transaction/50000"
                    );
                    const data = await response.json();

                    const resultDiv =
                        document.getElementById("transactionResult");
                    resultDiv.style.display = "block";

                    if (data.success) {
                        currentTransaction = data.transaction;
                        resultDiv.className = "result success";
                        resultDiv.innerHTML = `
                        <h4>‚úÖ Giao d·ªãch t·∫°o th√†nh c√¥ng!</h4>
                        <p><strong>Transaction ID:</strong> ${
                            data.transaction.transaction_id
                        }</p>
                        <p><strong>S·ªë ti·ªÅn:</strong> ${data.transaction.amount.toLocaleString()} VNƒê</p>
                        <p><strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong> ${
                            data.transaction.expected_content
                        }</p>
                        <p><strong>Ng√¢n h√†ng:</strong> ${
                            data.bank_info.name
                        } - ${data.bank_info.account_id}</p>
                    `;

                        // Show QR section
                        document.getElementById("qrSection").style.display =
                            "block";
                        document.getElementById("expectedContent").textContent =
                            data.transaction.expected_content;

                        const qrCodesDiv = document.getElementById("qrCodes");
                        qrCodesDiv.innerHTML = `
                        <div>
                            <h4>QR Code Compact (Recommended):</h4>
                            <img src="${data.qr_codes.vietqr_compact}" class="qr-image" alt="QR Compact">
                            <p><a href="${data.qr_codes.vietqr_compact}" target="_blank">M·ªü QR trong tab m·ªõi</a></p>
                        </div>
                        <div>
                            <h4>QR Code Full (In ·∫•n):</h4>
                            <img src="${data.qr_codes.vietqr_full}" class="qr-image" alt="QR Full">
                        </div>
                    `;

                        // Show webhook section
                        document.getElementById(
                            "webhookSection"
                        ).style.display = "block";
                    } else {
                        resultDiv.className = "result error";
                        resultDiv.innerHTML = `<h4>‚ùå L·ªói t·∫°o giao d·ªãch:</h4><pre>${JSON.stringify(
                            data,
                            null,
                            2
                        )}</pre>`;
                    }
                } catch (error) {
                    const resultDiv =
                        document.getElementById("transactionResult");
                    resultDiv.style.display = "block";
                    resultDiv.className = "result error";
                    resultDiv.innerHTML = `<h4>‚ùå L·ªói:</h4><p>${error.message}</p>`;
                }
            }

            async function checkQRContent() {
                if (!currentTransaction) {
                    alert("Vui l√≤ng t·∫°o giao d·ªãch tr∆∞·ªõc!");
                    return;
                }

                try {
                    const response = await fetch(
                        `/PTTKPM25-26_ClassN05_Nhom6/SRC/SM_Store/public/debug/qr-content-test/${currentTransaction.id}`
                    );
                    const data = await response.json();

                    const resultDiv = document.getElementById("qrResult");
                    resultDiv.style.display = "block";
                    resultDiv.className = "result info";
                    resultDiv.innerHTML = `
                    <h4>üîç Chi ti·∫øt n·ªôi dung QR:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                } catch (error) {
                    const resultDiv = document.getElementById("qrResult");
                    resultDiv.style.display = "block";
                    resultDiv.className = "result error";
                    resultDiv.innerHTML = `<h4>‚ùå L·ªói:</h4><p>${error.message}</p>`;
                }
            }

            async function simulateWebhook() {
                if (!currentTransaction) {
                    alert("Vui l√≤ng t·∫°o giao d·ªãch tr∆∞·ªõc!");
                    return;
                }

                try {
                    const response = await fetch(
                        `/PTTKPM25-26_ClassN05_Nhom6/SRC/SM_Store/public/debug/simulate-bank-webhook/${currentTransaction.transaction_id}`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        }
                    );
                    const data = await response.json();

                    const resultDiv = document.getElementById("webhookResult");
                    resultDiv.style.display = "block";

                    if (data.success) {
                        resultDiv.className = "result success";
                        resultDiv.innerHTML = `
                        <h4>‚úÖ Webhook th√†nh c√¥ng!</h4>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <p><strong>Transaction ID:</strong> ${
                            data.transaction_id
                        }</p>
                        <pre>${JSON.stringify(
                            data.webhook_response,
                            null,
                            2
                        )}</pre>
                    `;
                    } else {
                        resultDiv.className = "result error";
                        resultDiv.innerHTML = `<h4>‚ùå Webhook th·∫•t b·∫°i:</h4><pre>${JSON.stringify(
                            data,
                            null,
                            2
                        )}</pre>`;
                    }
                } catch (error) {
                    const resultDiv = document.getElementById("webhookResult");
                    resultDiv.style.display = "block";
                    resultDiv.className = "result error";
                    resultDiv.innerHTML = `<h4>‚ùå L·ªói:</h4><p>${error.message}</p>`;
                }
            }

            async function checkFirebase() {
                try {
                    const response = await fetch(
                        "/PTTKPM25-26_ClassN05_Nhom6/SRC/SM_Store/public/debug/firebase/balance/1"
                    );
                    const data = await response.json();

                    const resultDiv = document.getElementById("firebaseResult");
                    resultDiv.style.display = "block";
                    resultDiv.className = "result info";
                    resultDiv.innerHTML = `
                    <h4>üí∞ Th√¥ng tin Firebase:</h4>
                    <p><strong>User ID:</strong> ${data.user_id}</p>
                    <p><strong>Firebase Balance:</strong> ${
                        data.firebase_balance
                    } coins</p>
                    <p><strong>Service Balance:</strong> ${
                        data.balance_service_result
                    } coins</p>
                    <p><strong>Database URL:</strong> ${data.database_url}</p>
                    <pre>${JSON.stringify(
                        data.firebase_user_data,
                        null,
                        2
                    )}</pre>
                `;
                } catch (error) {
                    const resultDiv = document.getElementById("firebaseResult");
                    resultDiv.style.display = "block";
                    resultDiv.className = "result error";
                    resultDiv.innerHTML = `<h4>‚ùå L·ªói:</h4><p>${error.message}</p>`;
                }
            }
        </script>
    </body>
</html>
